#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

createHook() {
	declare desc="Creates a new webhook and adds it to http server and github"
	declare cmd="githook:hook-create"

	# Moves the input down by one so $1 will be the parameters after $cmd
	[[ "$1" == "$cmd" ]] && shift 1

	# The command format is $cmd $webhook $repository
	declare webhook=$1
	declare repository=$2

	source "$PLUGIN_AVAILABLE_PATH/githook/data-operations/hooks"
	if canAddHook "$webhook"
	then
		addHook "$webhook"
		createGithubHook $webhook $repository
	else
		echo "err: given hook already exist"
	fi
}

createGithubHook() {
	declare webhook=$1
	declare repository=$2
	declare ip=$(curl "ifconfig.me")

	echo "https://api.github.com/repos/$repository/hooks"
	curl \
	-i \
	-u "$GITHUB_USERNAME:$GITHUB_TOKEN" \
	-H "Accept: application/vnd.github.v3+json" \
	"https://api.github.com/repos/$repository/hooks" \
	-d "{'name': 'web','config': {'url': 'http://$ip:9000/$webhook', 'insecure_ssl': '1'}}"
}

createHook "$@"