#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

declare PLUGIN_PATH="$PLUGIN_AVAILABLE_PATH/githook"

createHook() {
	declare desc="Creates a new webhook and adds it to http server and github"
	declare cmd="githook:hook-create"

	# Moves the input down by one so $1 will be the parameters after $cmd
	[[ "$1" == "$cmd" ]] && shift 1

	# The command format is $cmd $webhook $repository
	declare webhook=$1
	declare repository=$2

	source "$PLUGIN_PATH/data-operations/hooks"
	if canAddHook "$webhook"
	then
		if createGithubHook $webhook $repository
		then
			addHook "$webhook"
			echo "Successfully added $webhook as a webhook"
		else
			echo "err: unable to create webhook on github, usually it's because hook already exist"
		fi
	else
		echo "err: given hook already exist"
	fi
}

createGithubHook() {
	declare webhook=$1
	declare repository=$2
	declare ip=$(curl "ifconfig.me")

	declare response=$(curl \
	-sS \
	-w '%{http_code}'\
	-u "$GITHUB_USERNAME:$GITHUB_TOKEN" \
	-H "Accept: application/vnd.github.v3+json" \
	"https://api.github.com/repos/$repository/hooks" \
	-d '{"name": "web","config": {"url": "http://'$ip:9000'/'$webhook'", "insecure_ssl": "1"}}')

	echo "\n"
	echo $response
	[[ "${response: -3}" == "201" ]] && return 0
	return 1
}

createHook "$@"